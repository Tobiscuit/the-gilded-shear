#!/usr/bin/env node

/**
 * Vercel Environment Variables Setup Script
 * 
 * This script helps set all required environment variables in Vercel.
 * Run with: node scripts/set-vercel-env.js
 */

const { execSync } = require('child_process');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// Environment variables that need to be set
const requiredEnvVars = [
  {
    name: 'NEXT_PUBLIC_FIREBASE_API_KEY',
    description: 'Firebase API Key (from Firebase Console)',
    required: true
  },
  {
    name: 'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN',
    description: 'Firebase Auth Domain (project-id.firebaseapp.com)',
    required: true
  },
  {
    name: 'NEXT_PUBLIC_FIREBASE_PROJECT_ID',
    description: 'Firebase Project ID',
    required: true
  },
  {
    name: 'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET',
    description: 'Firebase Storage Bucket (project-id.appspot.com)',
    required: true
  },
  {
    name: 'NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID',
    description: 'Firebase Messaging Sender ID',
    required: true
  },
  {
    name: 'NEXT_PUBLIC_FIREBASE_APP_ID',
    description: 'Firebase App ID',
    required: true
  },
  {
    name: 'NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID',
    description: 'Firebase Measurement ID (optional)',
    required: false
  }
];

// Note: Stripe keys should be set manually or read from .env.local
// They are NOT hardcoded here for security reasons

function askQuestion(question) {
  return new Promise((resolve) => {
    rl.question(question, (answer) => {
      resolve(answer.trim());
    });
  });
}

async function setVercelEnvVar(name, value, environment = 'production') {
  try {
    const command = `npx vercel env add ${name} ${environment}`;
    execSync(command, { input: value, stdio: ['pipe', 'inherit', 'inherit'] });
    console.log(`‚úÖ Set ${name} for ${environment}`);
    return true;
  } catch (error) {
    console.log(`‚ùå Failed to set ${name}: ${error.message}`);
    return false;
  }
}

async function main() {
  console.log('üîß Vercel Environment Variables Setup\n');
  
  // Check if Vercel CLI is available
  try {
    execSync('npx vercel --version', { stdio: 'pipe' });
  } catch (error) {
    console.log('‚ùå Vercel CLI not found. Please install it first:');
    console.log('npm install -g vercel');
    process.exit(1);
  }
  
  // Check if user is logged in
  try {
    execSync('npx vercel whoami', { stdio: 'pipe' });
  } catch (error) {
    console.log('‚ùå Not logged in to Vercel. Please run: npx vercel login');
    process.exit(1);
  }
  
  console.log('üìù You\'ll need Firebase configuration values from your Firebase Console.\n');
  
  const projectId = await askQuestion('Enter your Firebase Project ID: ');
  if (!projectId) {
    console.log('‚ùå Project ID is required');
    process.exit(1);
  }
  
  // Auto-generate some values based on project ID
  const autoGenerated = {
    'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN': `${projectId}.firebaseapp.com`,
    'NEXT_PUBLIC_FIREBASE_PROJECT_ID': projectId,
    'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET': `${projectId}.appspot.com`
  };
  
  console.log('\nüîß Setting up environment variables...\n');
  
  // Set Firebase variables
  for (const envVar of requiredEnvVars) {
    let value;
    
    if (autoGenerated[envVar.name]) {
      value = autoGenerated[envVar.name];
      console.log(`Using auto-generated value for ${envVar.name}: ${value}`);
    } else {
      value = await askQuestion(`Enter ${envVar.description}: `);
      if (!value && envVar.required) {
        console.log(`‚ùå ${envVar.name} is required`);
        continue;
      }
    }
    
    if (value) {
      await setVercelEnvVar(envVar.name, value);
    }
  }
  
  // Set Stripe variables (manual)
  console.log('\nüí≥ Setting up Stripe variables...\n');
  const stripeSecret = await askQuestion('Enter Stripe Secret Key: ');
  if (stripeSecret) {
    await setVercelEnvVar('STRIPE_SECRET_KEY', stripeSecret);
  }
  
  const stripePublic = await askQuestion('Enter Stripe Publishable Key: ');
  if (stripePublic) {
    await setVercelEnvVar('NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY', stripePublic);
  }
  
  // Set admin emails
  const adminEmails = await askQuestion('Enter admin emails (comma-separated): ');
  if (adminEmails) {
    await setVercelEnvVar('ADMIN_EMAILS', adminEmails);
  }
  
  console.log('\n‚úÖ Environment variables setup complete!');
  console.log('\nüöÄ Next steps:');
  console.log('1. Deploy your project: vercel --prod');
  console.log('2. Test the booking flow');
  console.log('3. Set up Firebase Functions: firebase deploy --only functions');
  
  rl.close();
}

// Run the script
if (require.main === module) {
  main().catch(console.error);
}
